<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NHREC — New Application (Step 3)</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root { --portal-green:#0f6b45; --portal-dark:#0b4f36; --panel-bg:#fff; }
    .portal-wrap { display:flex; min-height:100vh; background:#f3f6f8; }

    /* Sidebar */
    .portal-sidebar { width:260px; background:var(--portal-green); color:#fff; padding:2rem 1.25rem; box-shadow:2px 0 6px rgba(0,0,0,0.06); display:flex; flex-direction:column; gap:1rem; }
    .portal-brand { display:flex; gap:0.8rem; align-items:center; margin-bottom:1rem; }
    .portal-brand img { width:36px;height:36px;border-radius:6px;background:#fff;padding:3px; }
    .sidebar-link { display:block; padding:10px 12px; border-radius:8px; color:#e6f7ef; font-weight:600; margin:6px 0; }
    .sidebar-link.active { background: rgba(255,255,255,0.06); color:#fff; }

    /* Main */
    .portal-main { flex:1; display:flex; flex-direction:column; }
    .portal-header { height:64px; background: linear-gradient(90deg,var(--portal-green),var(--portal-dark)); color:white; display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .header-actions { display:flex; gap:12px; align-items:center; }
    .avatar { width:36px;height:36px;border-radius:50%;background:#ffffff22;display:inline-flex;align-items:center;justify-content:center;color:white;font-weight:700; }

    .content { padding:28px; }
    .panel { background:var(--panel-bg); border-radius:10px; padding:22px; box-shadow:0 1px 6px rgba(10,10,10,0.04); }

    h3.section-title { margin:0 0 14px 0; color:#0b2b3a; font-weight:700; }

    .row { display:flex; gap:16px; align-items:center; margin-top:12px; }
    .col-label { flex:0 0 220px; font-weight:700; color:#0b2b3a; }
    .col-control { flex:1; }

    input[type="text"], select, .file-input {
      width:100%; padding:12px; border:1px solid #e2e8f0; border-radius:8px; font-size:1rem; background:#fafafa;
    }

    .small { font-size:0.9rem; color:#6b7f86; margin-top:6px; }
    .team-list, .docs-list { margin-top:12px; display:flex; flex-direction:column; gap:12px; }
    .team-item, .doc-item, .site-item { display:flex; gap:12px; align-items:center; }
    .team-item .col-control, .doc-item .col-control, .site-item .col-control { flex:1; }

    .btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn-primary { background:#1fb35d; color:white; }
    .btn-ghost { background:transparent; border:1px solid #d1d7da; color:#0b2b3a; }
    .btn-add { background:var(--portal-green); color:white; }
    .remove-btn { background:#ffb020; color:white; border-radius:8px; padding:8px 10px; border:none; cursor:pointer; }

    .footer-actions { display:flex; gap:12px; align-items:center; margin-top:18px; }
    .status { margin-left:auto; color:#6b7f86; }
    .error { color:#c3422c; font-size:0.95rem; margin-top:8px; display:none; }

    /* Half-length Document Type dropdown */
    .doc-type { min-width:80px; }
    .file-input { max-width:520px; }
    .file-info { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; display:inline-block; }

    /* Research upload area */
    .upload-panel {
      margin-top:16px;
      padding:12px;
      border:1px dashed #d1d5db;
      border-radius:8px;
      background:#fbfdff;
    }
    .upload-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .upload-summary { margin-top:8px; font-size:0.95rem; color:#374151; }
    .file-list { margin-top:10px; max-height:180px; overflow:auto; border-top:1px solid #eef2f7; padding-top:8px; }
    .file-list-item { display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-bottom:1px dashed #f1f5f9; font-size:0.95rem; color:#0b2b3a; }
    .file-remove { background:transparent; color:#c3422c; border:none; cursor:pointer; font-weight:700; }

    .note { margin-top:8px; font-size:0.9rem; color:#6b7280; }

    @media (max-width:900px){
      .portal-sidebar{display:none;}
      .row{flex-direction:column; align-items:stretch;}
      .col-label{flex:auto;}
      .doc-type { min-width:70px; }
      .file-input { max-width:100%; }
      .file-info { max-width:120px; }
    }
  </style>
</head>
<body>
  <div class="portal-wrap">
    <aside class="portal-sidebar" role="navigation" aria-label="Main navigation">
      <div class="portal-brand">
        <img src="image/logo.png" alt="NHREC logo" />
        <div><strong>NHREC</strong><br/><small style="opacity:0.9">Research Ethics Portal</small></div>
      </div>
      <nav class="sidebar-nav">
        <a class="sidebar-link" href="portal.html">Home</a>
        <a class="sidebar-link" href="#">My Profile</a>
        <div style="opacity:0.9; font-size:0.85rem; margin:8px 0;">APPLICATION</div>
        <a class="sidebar-link" href="application-step2.html">New Application</a>
        <a class="sidebar-link active" href="#">View Applications</a>
        <div style="margin-top:auto; font-size:0.95rem; opacity:0.9;">© 2025 NRECOI</div>
      </nav>
    </aside>

    <main class="portal-main" role="main">
      <header class="portal-header">
        <h2>National Health Research Ethics Committee</h2>
        <div class="header-actions">
          <button id="helpBtn" class="btn btn-ghost">Help</button>
          <div id="avatar" class="avatar">A</div>
          <button id="logoutBtn" class="btn btn-ghost">Logout</button>
        </div>
      </header>

      <section class="content">
        <div class="panel">
          <h3>New Application — Details & Documents</h3>
          <div class="small">Complete form and attach required documents. After verification research files may be made public by the organisation.</div>

          <!-- Research title -->
          <div class="row" style="margin-top:18px;">
            <div class="col-label">Research Title <span style="color:#c3422c">*</span></div>
            <div class="col-control">
              <input id="researchTitle" type="text" placeholder="Enter research title" />
              <div id="titleError" class="error">Please enter a research title.</div>
            </div>
          </div>

          <!-- Sites -->
          <h3 class="section-title" style="margin-top:22px;">Sites</h3>
          <div id="sitesError" class="error">Please add at least one site (state or site name required).</div>
          <div id="sitesList" class="team-list"></div>
          <button id="addSiteBtn" class="btn btn-add" style="margin-top:10px;">+ Add More Sites</button>

          <!-- Research Team -->
          <h3 class="section-title" style="margin-top:22px;">Research Team</h3>
          <div id="teamError" class="error">Please add at least one research team member (role or name required).</div>
          <div id="teamList" class="team-list"></div>
          <button id="addTeamBtn" class="btn btn-add" style="margin-top:10px;">+ Add Team Member</button>

          <!-- Supporting Documents -->
          <h3 class="section-title" style="margin-top:22px;">Supporting Documents</h3>
          <div class="small">Allowed: .docx, .doc, .pdf. Max 5MB (client-side check only).</div>
          <div id="docsError" class="error">Please add at least one supporting document with a file selected.</div>
          <div id="docsList" class="docs-list"></div>
          <button id="addDocBtn" class="btn btn-add" style="margin-top:10px;">+ Add Supporting Document</button>

          <!-- Research upload (required) -->
          <h3 class="section-title" style="margin-top:22px;">Upload your research (required)</h3>
          <div class="small">Upload your research files — single files or folders. After verification the organisation may make approved research public.</div>
          <div id="uploadError" class="error">Please upload at least one research file or folder.</div>

          <div class="upload-panel" id="uploadPanel">
            <div class="upload-controls">
              <label style="display:inline-block; cursor:pointer;">
                <input id="researchUpload" class="file-input" type="file" accept="*/*" webkitdirectory directory multiple style="display:none;" />
                <span class="btn btn-ghost">Choose files or folder</span>
              </label>

              <button id="clearUploadBtn" class="btn btn-ghost">Clear selection</button>

              <div style="margin-left:auto;">
                <strong id="uploadCount">0 files</strong>
                <div class="upload-summary" id="uploadSize">Total: 0 B</div>
              </div>
            </div>

            <div class="file-list" id="fileList" aria-live="polite"></div>

            <div class="note">
              Note: This demo stores only metadata (filenames and sizes) locally. For production you must upload files to a server (consider chunked/resumable uploads for very large files).
            </div>
          </div>

          <!-- Footer -->
          <div class="footer-actions" style="margin-top:18px;">
            <button id="backBtn" class="btn btn-ghost">Back</button>
            <button id="saveBtn" class="btn btn-primary">Save Application</button>
            <div id="saveStatus" class="status">Not saved</div>

            <!-- Post-save notice + proceed button (hidden until save) -->
            <div id="postSaveMessage" class="small" style="display:none; margin-left:12px; color:#0b5440;">
              After verifying your research, our team may make your research available to the public. Publishing is handled in Application Step 4.
              <button id="gotoStep4" class="btn btn-ghost" style="margin-left:12px;">Proceed to Step 4</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  (function(){
    // Access check (simple)
    try {
      if (!localStorage.getItem('nhrec_logged_in')) { window.location.href = 'Login.html'; return; }
    } catch(e){}

    // Elements
    const researchTitle = document.getElementById('researchTitle');
    const sitesList = document.getElementById('sitesList');
    const teamList = document.getElementById('teamList');
    const docsList = document.getElementById('docsList');
    const addSiteBtn = document.getElementById('addSiteBtn');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const addDocBtn = document.getElementById('addDocBtn');
    const saveBtn = document.getElementById('saveBtn');
    const backBtn = document.getElementById('backBtn');
    const saveStatus = document.getElementById('saveStatus');

    const titleErr = document.getElementById('titleError');
    const sitesErr = document.getElementById('sitesError');
    const teamErr = document.getElementById('teamError');
    const docsErr = document.getElementById('docsError');
    const uploadErr = document.getElementById('uploadError');

    const researchUpload = document.getElementById('researchUpload');
    const fileList = document.getElementById('fileList');
    const uploadCount = document.getElementById('uploadCount');
    const uploadSize = document.getElementById('uploadSize');
    const clearUploadBtn = document.getElementById('clearUploadBtn');

    const postSaveMessage = document.getElementById('postSaveMessage');
    const gotoStep4Btn = document.getElementById('gotoStep4');

    const storageKey = 'nhrec_application_full';

    // Indian states
    const indianStates = [
      "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat","Haryana",
      "Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra","Manipur","Meghalaya",
      "Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura",
      "Uttar Pradesh","Uttarakhand","West Bengal",
      "Andaman and Nicobar Islands","Chandigarh","Dadra and Nagar Haveli and Daman and Diu",
      "Delhi (NCT)","Jammu & Kashmir","Ladakh","Lakshadweep","Puducherry"
    ];

    const teamRoles = ["PI","Co-PI","Sponsor","Investor","Supervisor","Other"];

    const docTypes = [
      "Protocol","PI CV","Co-Investigator Attestation Statement","Sponsor Attestation Statement",
      "MTA","CTA","Research Summary","Informed Consent","Attestation Letter",
      "Patient Information Leaflet","Questionnaire","Budget","Other"
    ];

    // dynamic creators
    function createSiteRow(data){
      const wrapper = document.createElement('div');
      wrapper.className = 'site-item';
      wrapper.innerHTML = `
        <div class="col-control" style="display:flex;gap:12px;align-items:center;">
          <select class="site-state" style="min-width:180px;">
            <option value="">Select state / UT</option>
          </select>
          <input type="text" class="site-name" placeholder="Site (e.g., Hospital / Clinic)" />
        </div>
        <button type="button" class="remove-btn" title="Remove site">✕</button>
      `;
      const select = wrapper.querySelector('.site-state');
      indianStates.forEach(s => { const opt = document.createElement('option'); opt.value=s; opt.textContent=s; select.appendChild(opt); });
      const name = wrapper.querySelector('.site-name');
      wrapper.querySelector('.remove-btn').addEventListener('click', () => { wrapper.remove(); markUnsaved(); });
      select.addEventListener('change', markUnsaved);
      name.addEventListener('input', markUnsaved);
      if (data) { if (data.state) select.value = data.state; if (data.name) name.value = data.name; }
      return wrapper;
    }

    function createTeamRow(data){
      const wrapper = document.createElement('div');
      wrapper.className = 'team-item';
      wrapper.innerHTML = `
        <div class="col-control" style="display:flex;gap:12px;align-items:center;">
          <select class="team-role" style="min-width:160px;">
            <option value="">Select role</option>
          </select>
          <input type="text" class="team-name" placeholder="Name / Organisation" />
        </div>
        <button type="button" class="remove-btn" title="Remove team member">✕</button>
      `;
      const select = wrapper.querySelector('.team-role');
      teamRoles.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; select.appendChild(o); });
      wrapper.querySelector('.remove-btn').addEventListener('click', () => { wrapper.remove(); markUnsaved(); });
      select.addEventListener('change', markUnsaved);
      wrapper.querySelector('.team-name').addEventListener('input', markUnsaved);
      if (data) { if (data.role) select.value = data.role; if (data.name) wrapper.querySelector('.team-name').value = data.name; }
      return wrapper;
    }

    function createDocRow(data){
      const wrapper = document.createElement('div');
      wrapper.className = 'doc-item';
      wrapper.innerHTML = `
        <div class="col-control" style="display:flex;gap:8px;align-items:center;">
          <select class="doc-type">
            <option value="">Document Type</option>
          </select>
          <input class="file-input" type="file" accept=".pdf,.doc,.docx" />
          <span class="small file-info">No file selected</span>
        </div>
        <button type="button" class="remove-btn" title="Remove document">✕</button>
      `;
      const select = wrapper.querySelector('.doc-type');
      docTypes.forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; select.appendChild(o); });
      const fileInput = wrapper.querySelector('.file-input');
      const fileInfo = wrapper.querySelector('.file-info');
      wrapper.querySelector('.remove-btn').addEventListener('click', () => { wrapper.remove(); markUnsaved(); });
      select.addEventListener('change', markUnsaved);
      fileInput.addEventListener('change', () => {
        const f = fileInput.files[0];
        if (!f) { fileInfo.textContent = 'No file selected'; markUnsaved(); return; }
        if (f.size > 5 * 1024 * 1024) { alert('File too large. Max 5MB allowed for supporting docs.'); fileInput.value=''; fileInfo.textContent='No file selected'; return; }
        fileInfo.textContent = f.name;
        markUnsaved();
      });
      if (data) {
        if (data.docType) select.value = data.docType;
        if (data.filename) fileInfo.textContent = data.filename;
      }
      return wrapper;
    }

    // research uploads
    let uploadedFiles = []; // File objects (or metadata on restore)

    function handleResearchSelection(files){
      uploadedFiles = Array.from(files || []);
      renderFileList();
      markUnsaved();
    }

    function renderFileList(){
      fileList.innerHTML = '';
      if (!uploadedFiles || uploadedFiles.length === 0) {
        uploadCount.textContent = '0 files';
        uploadSize.textContent = 'Total: 0 B';
        return;
      }
      let total = 0;
      uploadedFiles.forEach((f, idx) => {
        total += f.size || 0;
        const item = document.createElement('div');
        item.className = 'file-list-item';
        const left = document.createElement('div');
        left.textContent = (f.webkitRelativePath && f.webkitRelativePath.length) ? f.webkitRelativePath : f.name;
        const right = document.createElement('div');
        right.innerHTML = `${formatBytes(f.size)} <button class="file-remove" data-index="${idx}">Remove</button>`;
        item.appendChild(left); item.appendChild(right);
        fileList.appendChild(item);
      });
      uploadCount.textContent = `${uploadedFiles.length} file${uploadedFiles.length>1?'s':''}`;
      uploadSize.textContent = 'Total: ' + formatBytes(total);
      Array.from(fileList.querySelectorAll('.file-remove')).forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.index);
          uploadedFiles.splice(i,1);
          renderFileList();
          markUnsaved();
        });
      });
    }

    function formatBytes(bytes){
      if (!bytes) return '0 B';
      const units = ['B','KB','MB','GB','TB'];
      let i = 0;
      while (bytes >= 1024 && i < units.length-1){ bytes /= 1024; i++; }
      return `${Math.round(bytes*10)/10} ${units[i]}`;
    }

    // wiring
    researchUpload.addEventListener('change', (e) => handleResearchSelection(e.target.files));
    clearUploadBtn.addEventListener('click', (e) => { e.preventDefault(); researchUpload.value=''; uploadedFiles=[]; renderFileList(); markUnsaved(); });
    addSiteBtn.addEventListener('click', (e)=>{ e.preventDefault(); sitesList.appendChild(createSiteRow()); markUnsaved(); });
    addTeamBtn.addEventListener('click', (e)=>{ e.preventDefault(); teamList.appendChild(createTeamRow()); markUnsaved(); });
    addDocBtn.addEventListener('click', (e)=>{ e.preventDefault(); docsList.appendChild(createDocRow()); markUnsaved(); });

    function markUnsaved(){ saveStatus.textContent = 'Not saved'; saveStatus.style.color = '#6b7f86'; }

    function collectForm(){
      const titleVal = researchTitle.value.trim();
      const sites = Array.from(sitesList.querySelectorAll('.site-item')).map(row => ({
        state: row.querySelector('.site-state').value,
        name: row.querySelector('.site-name').value.trim()
      })).filter(s => s.state || s.name);

      const team = Array.from(teamList.querySelectorAll('.team-item')).map(row => ({
        role: row.querySelector('.team-role').value,
        name: row.querySelector('.team-name').value.trim()
      })).filter(t => t.role || t.name);

      const docs = Array.from(docsList.querySelectorAll('.doc-item')).map(row => {
        const docType = row.querySelector('.doc-type').value;
        const fileInfo = row.querySelector('.file-info').textContent;
        return { docType, filename: fileInfo && fileInfo !== 'No file selected' ? fileInfo : '' };
      }).filter(d => d.docType || d.filename);

      const uploads = uploadedFiles.map(f => ({
        name: f.name,
        relativePath: f.webkitRelativePath || f.name,
        size: f.size || 0
      }));

      // Add status to indicate it's awaiting verification after saving step 3
      return { title: titleVal, sites, team, docs, uploads, status: "awaiting_verification", savedAt: new Date().toISOString() };
    }

    // validation
    function validateBeforeSave(){
      const data = collectForm();
      let ok = true;
      if (!data.title) { titleErr.style.display='block'; ok=false; } else titleErr.style.display='none';

      if (!data.sites || data.sites.length === 0) { sitesErr.style.display='block'; ok=false; }
      else {
        const hasSite = data.sites.some(s => (s.state && s.state.trim()) || (s.name && s.name.trim()));
        if (!hasSite) { sitesErr.style.display='block'; ok=false; } else sitesErr.style.display='none';
      }

      if (!data.team || data.team.length===0) { teamErr.style.display='block'; ok=false; }
      else {
        const hasTeam = data.team.some(t => (t.role && t.role.trim()) || (t.name && t.name.trim()));
        if (!hasTeam) { teamErr.style.display='block'; ok=false; } else teamErr.style.display='none';
      }

      const hasDocWithFile = data.docs && data.docs.some(d => d.filename && d.filename.trim());
      if (!hasDocWithFile) { docsErr.style.display='block'; ok=false; } else docsErr.style.display='none';

      if (!data.uploads || data.uploads.length===0) { uploadErr.style.display='block'; ok=false; } else uploadErr.style.display='none';

      return ok;
    }

    // Save handler (updated to show post-save message and set status)
    saveBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (!validateBeforeSave()) {
        const firstErr = document.querySelector('.error[style*="display: block"]');
        if (firstErr) firstErr.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      const payload = collectForm();
      // Save metadata locally (demo). In production push to server.
      localStorage.setItem(storageKey, JSON.stringify(payload));

      // UI feedback
      saveStatus.textContent = 'Saved locally';
      saveStatus.style.color = 'green';

      // Show the post-save message and reveal Proceed to Step 4 button
      if (postSaveMessage) {
        postSaveMessage.style.display = 'inline-block';
        postSaveMessage.setAttribute('tabindex','-1');
        postSaveMessage.focus();
      }

      // Small alert to mirror previous behavior (keeps demo UX)
      setTimeout(()=> {
        alert('Application metadata saved (demo). To publish research files, implement server uploads. Publishing is handled in Application Step 4.');
      }, 100);
    });

    // Proceed to step 4 wiring
    if (gotoStep4Btn) {
      gotoStep4Btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        // Navigate to step 4 where verification/publishing flow lives
        window.location.href = 'application-step4.html';
      });
    }

    backBtn.addEventListener('click', ()=>{ window.location.href = 'application-step2.html'; });

    // restore
    function restore(){
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) {
          sitesList.appendChild(createSiteRow());
          teamList.appendChild(createTeamRow());
          docsList.appendChild(createDocRow());
          renderFileList();
          return;
        }
        const d = JSON.parse(raw);
        if (d.title) researchTitle.value = d.title;
        if (Array.isArray(d.sites) && d.sites.length) d.sites.forEach(s => sitesList.appendChild(createSiteRow(s))); else sitesList.appendChild(createSiteRow());
        if (Array.isArray(d.team) && d.team.length) d.team.forEach(t => teamList.appendChild(createTeamRow(t))); else teamList.appendChild(createTeamRow());
        if (Array.isArray(d.docs) && d.docs.length) d.docs.forEach(doc => docsList.appendChild(createDocRow(doc))); else docsList.appendChild(createDocRow());
        if (Array.isArray(d.uploads) && d.uploads.length) {
          uploadedFiles = d.uploads.map(m => ({ name: m.name || m.relativePath || 'file', size: m.size || 0, webkitRelativePath: m.relativePath || m.name || '' }));
        } else uploadedFiles = [];
        renderFileList();

        // If an application was already saved and has status awaiting_verification, show the post-save message
        if (d.status && d.status === 'awaiting_verification' && postSaveMessage) {
          postSaveMessage.style.display = 'inline-block';
        }

        saveStatus.textContent = 'Loaded saved progress';
      } catch(e){
        console.warn('restore error', e);
        sitesList.appendChild(createSiteRow());
        teamList.appendChild(createTeamRow());
        docsList.appendChild(createDocRow());
        uploadedFiles = [];
        renderFileList();
      }
    }

    // avatar & help/logout
    try {
      const avatar = document.getElementById('avatar');
      const email = localStorage.getItem('nhrec_user_email');
      if (email) { avatar.textContent = email[0].toUpperCase(); avatar.title = email; }
    } catch(e){}
    document.getElementById('helpBtn').addEventListener('click', ()=> alert('Need help? Contact portal@nhrec.gov or consult the FAQs.'));
    document.getElementById('logoutBtn').addEventListener('click', ()=> window.location.href = 'Login.html');

    // init
    restore();
  })();
  </script>
</body>
</html>
